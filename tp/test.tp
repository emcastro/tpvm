// Testbed 1
__eq__=#eq
__lt__=#lt
__concat__=#list_concat
__plus__=#plus
__minus__=#minus
__or__=(a,b)->if (a) a else b

// Lists
_head(list)=list(0)
_tail(list)=list.tailFrom(1)
_tailFrom(list,n) = #list_tailFrom(list,n)
_sublist(list,from,to) = #list_sublist(list,from,to)
_length(list)=#list_length(list)
_empty(list)=list.length==0

_asList=#string_asList
_asString(list) = {
    list.map(#fromCharCode).foldLeft("",#plus)
}

lone(list)=if(list.length == 1) list(0) else #error("Size must be 1")
char(s) = lone(s.asList)

//

_spy(self) = #spy(self)

_flatmap(list, f) = {
    if (list.empty) #nil
    else {
        f(list.head) ++ list.tail.flatmap(f)
    }
}

_map(list, f) = list.flatmap(e->#list(f(e)))

/* // Lazy Standard version
_filter(list, f) = {
    if (list.empty) #nil
    else {
        if (f(list.head))
            #list(list.head) ++ list.tail.filter(f)
        else
            list.tail.filter(f)
    }
}
*/

_filter_(list, f, result) = {
    if (list.empty) result
    else {
        if (f(list.head))
            list.tail.filter_(f, result ++ #list(list.head))
        else
            list.tail.filter_(f, result)
    }
}

_filter(list, f) = _filter_(list, f, #nil)

_split_(list, isDelim, accumulator, result) = {
    if (list.empty) {
        result ++ #list(accumulator) // flush the accumulator
    } else {
        if (isDelim(list.head))
            list.tail.split_(isDelim, #nil, result ++ #list(accumulator)) // start a new accumulator
        else 
            list.tail.split_(isDelim, accumulator ++ #list(list.head), result) // put un the accumulator
    }
}

_split(list, isDelim) = if (list.empty) #nil else _split_(list, isDelim, #nil, #nil)

_foldLeft(list, zero, op) = {
    loop(list, state) = {
        if (list.empty) state
        else {
            loop(list.tail, state op list.head)
        }
    }

    loop(list,zero)
}

_join(list, delim) = {
    list.flatmap(item->delim++item).asString
}

integers(from, to) = {
  ints(from, to, result) = {
    if (from < to) ints(from+1, to, result ++ #list(from))
    else result
  }

  ints(from, to, #nil)
} 

/* ------------------ */


file = #readFile("test").asList

lines = file.split(c->c == char("\n"))
linesOfWords = lines.map(l->l.split(c->c == char(",")))

transformedLines = linesOfWords.map(words->words.join("|".asList))


lines.map(x->#delay(500,x.asString).asList).join("$\n".asList)

//transformedLines

